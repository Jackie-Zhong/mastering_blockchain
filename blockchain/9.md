### 挖矿和共识

挖矿是增加比特币货币供应的一个过程。挖矿同时还保护着比特币系统的安全，防止欺诈交易，避免双重支付，双重支付是指多次花费同一笔比特币。矿工通过为比特币网络提供算力来获得比特币奖励的机会。

矿工验证每笔新的交易并把它们记录在区块链上。每10分钟就会有一个新的区块被挖掘出来，每个区块里包含着从上一个区块产生到目前这段时间内发生的所有交易，这些交易被依次添加到区块链中。我们把包含在区块内且被添加到区块链上的交易称为确认交易，交易经过确认之后，新的拥有者才能花费他在此交易中得到的比特币。

矿工在挖矿过程中会得到两种类型的奖励：创建新区块的新币奖励，以及区块中所含交易的交易费。为了得到这些奖励，矿工们争相完成一种基于加密哈希算法的数学难题，这些难题的答案包括在新区块中，作为矿工的工作量证明。

新比特币的生成过程被称为挖矿是因为它的奖励机制被设计为速度递减模式。矿工通过创造一个新区块得到的比特币数量大约每四年减少一半。开始时为2009年1月每个区块奖励50个比特币，然后到2012年11月减半为每个区块奖励25个比特币。之后在2016年7月再次减半为每个新区块奖励12.5个比特币。基于这个公式，比特币挖矿奖励以指数方式递减，直到2140年。届时所有的比特币20,999,999,980全部发行完毕。

每笔交易都可能包含一笔交易费，交易费是每笔交易记录的输入和输出的差额。在挖矿过程中成功挖出新区块的矿工可以得到该区块中包含的所有的交易费。

![](1)

#### 去中心化共识

在不考虑相信任何人的情况下，比特币网络中的所有参与者如何达成对任意一个所有权的共识呢？所有的传统支付系统都依赖于一个中心认证机构，依靠中心机构提供的结算服务来验证并处理所有的交易。比特币没有中心机构，几乎所有的完整节点都有一份公共总帐的备份，这份总帐可以被视为认证过的记录。区块链并不是由一个中心机构创造的，它是由比特币网络中的所有节点各自独立竞争完成的。换句话说比特币网络中的所有节点，依靠着节点间的不稳定的网络连接所传输的信息，最终得出同样的结果并维护了同一个公共总帐。这一章将介绍比特币网络不依靠中心机构而达成共识的机制。

中本聪的主要发明就是这种去中心化的自发共识机制。这种自发，是指没有经过明确选举或者没有固定达成的共识的时间。换句话说，共识是数以千计的独立节点遵守了简单的规则通过异步交互自发形成的产物。所有的比特币属性，包括货币、交易、支付以及不依靠中心机构和信任的安全模型等都是这个机制的衍生物。比特币的去中心化共识由所有网络节点的4种独立过程相互作用而产生：

- 每个全节点依据综合标准对每个交易进行独立验证
- 通过完成工作量证明算法的验算，挖矿节点将交易记录独立打包进新区块，
-  每个节点独立的对新区块进行校验并组装进区块链
-  每个节点对区块链进行独立选择，在工作量证明机制下选择累计工作量最大的区块链

#### 交易的独立校验

我们知道了钱包软件通过收集UTXO、提供正确的解锁脚本、构造支付给接收者的输出这一系列的方式来创建交易。产生的交易随后将被发送到比特币网络临近的节点，从而使得该交易能够在整个比特币网络中传播。

然而，在交易传递到临近的节点前，每一个收到交易的比特币节点将会首先验证该交易，这将确保只有有效的交易才会在网络中传播，而无效的交易将被废弃。

每一个节点在校验每一笔交易时，都需要对照一个长长的标准列表：

- 交易的语法和数据结构必须正确
- 输入与输出列表都不能为空
- 交易的字节大小是小于MAX_BLOCK_SIZE的
- 每一个输出值，以及总量，必须在规定值的范围内
- 没有哈希等于0
- nLockTime是小于或等于INT_MAX的
- 交易的字节大小是大于或等于100的
- 交易中的签名数量应小于签名操作数量上限
- 解锁脚本只能够将数字压入栈中，并且锁定脚本必须要符合isStandard的格式
- 池中或位于主分支区块中的一个匹配交易必须是存在的
- 对于每一个输入，如果引用的输出存在于池中任何的交易，该交易将被拒绝
- 对于每一个输入，在主分支和交易池中寻找引用的输出交易。如果输出交易缺少任何一个输入，该交易将成为一个孤立的交易
- 对于每一个输入，如果引用的输出交易是一个coinbase输出，该输入必须至少获得100个确认
- 对于每一个输入，引用的输出是必须存在的，并且没有被花费
- 使用引用的输出交易获得输入值，并检查每一个输入值和总值是否在规定值的范围内
- 如果输入值的总和小于输出值的总和，交易将被中止
- 如果交易费用太低以至于无法进入一个空的区块，交易将被拒绝
- 每一个输入的解锁脚本必须依据相应输出的锁定脚本来验证

在收到交易后，，每一个节点都会在全网广播前对这些交易进行校验，并以接收时的相应顺序，为有效的新交易建立一个池（交易池）。

#### 整合交易至区块

验证交易后，比特币节点会将这些交易添加到自己的内存池中。与其他节点一样，矿工节点会收集、验证并中继新的交易。而且矿工节点会把这些交易整合到一个候选区块中。

矿工节点维护了一个区块链的本地副本，包含了自2009年比特币系统启动运行以来的全部区块。假如，矿工节点的区块链已经收集到了区块277,314，并继续监听着网络上的交易，在尝试挖掘新区块的同时，也监听着由其他节点发现的区块。当矿工节点在挖矿时，它从比特币网络收到了区块277,315。这个区块的到来标志着277,315区块竞赛的结束，与此同时也是产出区块277,316竞赛的开始。

在上一个10分钟内，当矿工节点正在寻找区块277,315的解的同时，它也在收集交易记录为下一个区块做准备。目前它已经收到了几百笔交易记录，并将它们放进了内存池。当接收并验证区块277,315后，矿工节点会检查内存池中的全部交易，并移除已经在区块277,315中出现过的交易记录，确保任何留在内存池中的交易都是未确认的，等待被记录到新区块中。

矿工节点立刻构建一个新的空区块，做为区块277,316的候选区块。称作候选区块是因为它还没有包含有效的工作量证明，不是一个有效的区块，而只有在矿工成功找到一个工作量证明解之后，这个区块才生效。

**交易块龄，矿工费和优先级**

矿工的比特币节点需要为内存池中的每笔交易分配一个优先级，并选择较高优先级的交易记录来构建候选区块。交易的优先级是由交易输入所花费的UTXO的块龄和交易输入值的大小来决定的，块龄大的交易比那些新的、输入值小的交易拥有更高的优先级。如果区块中有足够的空间，高优先级的交易将不需要矿工费。

区块中用来存储交易的前50K字节是保留给较高优先级交易的。矿工节点在填充这50K字节的时候，会优先考虑这些最高优先级的交易，不管它们是否包含了矿工费。这种机制使得高优先级交易即便是零矿工费，也可以优先被处理。矿工的挖矿节点也会选出那些包含最小矿工费的交易，并按照每千字节矿工费进行排序，优先选择矿工费高的交易来填充剩下的区块。如果区块中仍有剩余空间，挖矿节点可以选择那些不含矿工费的交易。

在区块被填满后，内存池中的剩余交易会成为下一个区块的候选交易。因为这些交易还留在内存池中，所以随着新的区块被加到链上，这些交易输入时所引用UTXO的块龄也会随着变大。由于交易的优先值取决于它交易输入的块龄，所以这个交易的优先值也就随之增长了。最后，一个零矿工费交易的优先值就有可能会满足高优先级的门槛，被免费地打包进区块。

**创币交易**

区块中的第一笔交易是笔特殊交易，称为创币交易或者coinbase交易。这个交易是由矿工节点构造并用来奖励矿工们所做的贡献。矿工节点会创建“向矿工的地址支付25.09094928个比特币”这样一个交易，把生成交易的奖励发送到自己的钱包。矿工挖出区块获得的奖励金额是coinbase奖励和区块中全部交易矿工费的总和。

与常规交易不同，创币交易没有输入，不消耗UTXO。它只包含一个被称作coinbase的输入，仅仅用来创建新的比特币。创币交易有一个输出，支付到这个矿工的比特币地址。

#### 构造区块头
