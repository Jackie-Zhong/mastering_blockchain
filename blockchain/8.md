### 区块链

区块链是由包含交易信息的区块从后向前有序链接起来的数据结构。比特币核心客户端使用Google的LevelDB数据库存储区块链元数据。区块被从后向前有序地链接在这个链条里，每个区块都指向前一个区块。区块链经常被视为一个垂直的栈，第一个区块作为栈底的首区块，随后每个区块都被放置在其他区块之上。

对每个区块头进行SHA256加密哈希，可生成一个哈希值。通过这个哈希值，可以识别出区块链中的对应区块。同时，每一个区块都可以通过其区块头的“父区块哈希值”字段引用前一区块。也就是说，每个区块头都包含它的父区块哈希值。这样把每个区块链接到各自父区块的哈希值序列就创建了一条一直可以追溯到第一个区块的链条。

虽然每个区块只有一个父区块，但可以暂时拥有多个子区块。每个子区块都将同一区块作为其父区块，并且在“父区块哈希值”字段中具有相同的哈希值。一个区块出现多个子区块的情况被称为“区块链分叉”。区块链分叉只是暂时状态，只有当多个不同区块几乎同时被不同的矿工发现时才会发生。最终，只有一个子区块会成为区块链的一部分，同时解决了“区块链分叉”的问题。尽管一个区块可能会有不止一个子区块，但每一区块只有一个父区块，这是因为一个区块只有一个“父区块哈希值”字段可以指向它的唯一父区块。

由于区块头里面包含“父区块哈希值”字段，所以当前区块的哈希值因此也受到该字段的影响。如果父区块的身份标识发生变化，子区块的身份标识也会跟着变化。当父区块有任何改动时，父区块的哈希值也发生变化。父区块的哈希值发生改变将迫使子区块的“父区块哈希值”字段发生改变，从而又将导致子区块的哈希值发生改变。而子区块的哈希值发生改变又将迫使孙区块的“父区块哈希值”字段发生改变，又因此改变了孙区块哈希值，等等以此类推。一旦一个区块有很多代以后，这种瀑布效应将保证该区块不会被改变，除非强制重新计算该区块所有后续的区块。正是因为这样的重新计算需要耗费巨大的计算量，所以一个长区块链的存在可以让区块链的历史不可改变，这也是比特币安全性的一个关键特征。 

#### 区块结构

区块是一种被包含在区块链里的聚合了交易信息的数据结构。它由一个包含元数据的区块头和紧跟其后的构成区块主体的一长串交易组成。区块头是80字节，而平均每个交易至少是250字节，而且平均每个区块至少包含超过500个交易。

| 大小  | 字段  | 描述  |
| ------------ | ------------ | ------------ |
| 4字节  | 区块大小  | 用字节表示的该字段之后的区块大小  |
| 80字节  | 区块头  | 组成区块头的几个字段  |
| 1-9 （可变整数）| 交易计数器  | 交易的数量  |
| 可变的  | 交易  | 记录在区块里的交易信息  |

#### 区块头

区块头由三组区块元数据组成。
- 父区块哈希值
- 难度、时间戳和nonce
- merkle树根

| 大小  | 字段  | 描述  |
| ------------ | ------------ | ------------ |
| 4字节  | 版本  | 版本号，用于跟踪软件/协议的更新  |
| 32字节  | 父区块哈希值  | 引用区块链中父区块的哈希值  |
| 32字节  | Merkle根  | 该区块中交易的merkle树根的哈希值  |
| 4字节  | 时间戳  | 该区块产生的近似时间  |
| 4字节  | 难度目标  | 该区块工作量证明算法的难度目标  |
| 4字节  | Nonce  | 用于工作量证明算法的计数器  |

#### 区块头哈希值和区块高度

区块主标识符是它的加密哈希值，一个通过SHA256算法对区块头进行二次哈希计算而得到的数字指纹。产生的32字节哈希值被称为区块哈希值，但是更准确的名称是：区块头哈希值，因为只有区块头被用于计算。

例如:000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f是第一个比特币区块的区块哈希值。区块哈希值可以唯一、明确地标识一个区块，并且任何节点通过简单地对区块头进行哈希计算都可以独立地获取该区块哈希值。

区块哈希值实际上并不包含在区块的数据结构里，不管是该区块在网络上传输时，抑或是它作为区块链的一部分被存储在某节点的永久性存储设备上时。相反，区块哈希值是当该区块从网络被接收时由每个节点计算出来的。区块的哈希值可能会作为区块元数据的一部分被存储在一个独立的数据库表中，以便于索引和更快地从磁盘检索区块。

第二种识别区块的方式是通过该区块在区块链中的位置，即区块高度。第一个区块，其区块高度为0。每一个随后被存储在第一个区块之上的区块在区块链中都比前一区块“高”出一个位置。

#### 创世区块

区块链里的第一个区块创建于2009年，被称为创世区块。它是区块链里面所有区块的共同祖先，这意味着你从任一区块，循链向后回溯，最终都将到达创世区块。

因为创世区块被编入到比特币客户端软件里，所以每一个节点都始于至少包含一个区块的区块链，这能确保创世区块不会被改变。每一个节点都知道创世区块的哈希值、结构、被创建的时间和里面的一个交易。因此，每个节点都把该区块作为区块链的首区块，从而构建了一个安全的、可信的区块链的根。 

创世区块的哈希值为：

    0000000000 19d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f

#### 区块的连接

比特币的完整节点保存了区块链从创世区块起的一个本地副本。随着新的区块的产生，该区块链的本地副本会不断地更新用于扩展这个链条。当一个节点从网络接收传入的区块时，它会验证这些区块，然后链接到现有的区块链上。为建立一个连接，一个节点将检查传入的区块头并寻找该区块的父区块哈希值。 

![](1)

#### Merkle 树

区块链中的每个区块都包含了产生于该区块的所有交易，且以Merkle树表示。Merkle树是一种哈希二叉树，它是一种用作快速归纳和校验大规模数据完整性的数据结构。这种二叉树包含加密哈希值。

在比特币网络中，Merkle树被用来归纳一个区块中的所有交易，同时生成整个交易集合的数字指纹，且提供了一种校验区块是否存在某交易的高效途径。生成一棵完整的Merkle树需要递归地对哈希节点对进行哈希，并将新生成的哈希节点插入到Merkle树中，直到只剩一个哈希节点，该节点就是Merkle树的根。在比特币的Merkle树中两次使用到了SHA256算法，因此其加密哈希算法也被称为double-SHA256。

Merkle树是自底向上构建的。我们从A、B、C、D四个构成Merkle树树叶的交易开始。起始时所有的交易都还未存储在Merkle树中，而是先将数据哈希化，然后将哈希值存储至相应的叶子节点。这些叶子节点分别是HA、HB、HC和HD：

    H~A~ = SHA256(SHA256(交易A))

通过串联相邻叶子节点的哈希值然后哈希之，这对叶子节点随后被归纳为父节点。 例如，为了创建父节点HAB，子节点A和子节点B的两个32字节的哈希值将被串联成64字节的字符串。随后将字符串进行两次哈希来产生父节点的哈希值:

    H~AB~=SHA256(SHA256(H~A~ + H~B~))

继续类似的操作直到只剩下顶部的一个节点，即Merkle根。产生的32字节哈希值存储在区块头。

![](1)

因为Merkle树是二叉树，所以它需要偶数个叶子节点。如果仅有奇数个交易需要归纳，那最后的交易就会被复制一份以构成偶数个叶子节点。

![](1)

由四个交易构造Merkle树的方法同样适用于从任意交易数量构造Merkle树。在比特币中，在单个区块中有成百上千的交易是非常普遍的，这些交易都会采用同样的方法归纳起来，产生一个仅仅32字节的数据作为Merkle根。

![](1)

为了证明区块中存在某个特定的交易，一个节点只需要计算log2(N)个32字节的哈希值，形成一条从特定交易到树根的认证路径或者Merkle路径即可。这使得比特币节点能够高效地产生一条10或者12个哈希值的路径，来证明了在一个巨量字节大小的区块中上千交易中的某笔交易的存在。

比如，一个节点能够通过生成一条仅有4个32字节哈希值长度的Merkle路径，来证明区块中存在一笔交易K。该路径有4个哈希值HL、HIJ、HMNOP和HABCDEFGH。由这4个哈希值产生的认证路径，再通过计算另外四对哈希值HKL、HIJKL、HIJKLMNOP和Merkle树根，任何节点都能证明HK包含在Merkle根中。

![](1)

Merkle树的高效随着交易规模的增加而变得异常明显。当区块大小由16笔交易急剧增加至65,535笔交易时，为证明交易存在的Merkle路径长度增长极其缓慢，仅仅从128字节到512字节。

| 交易数量  | 区块的近似大小  | 路径大小（哈希数量）  | 路径大小（字节）  |
| ------------ | ------------ | ------------ | ------------ |
| 16笔交易  | 4KB  | 4个哈希  | 128字节  |
| 512笔交易  | 128KB  | 9个哈希  | 288字节  |
| 2048笔交易  | 512KB  | 11个哈希  | 352字节  |
| 65,535笔交易  | 16MB  | 16个哈希  | 512字节  |

有了Merkle树，一个节点能够仅下载区块头，然后通过从一个满节点回溯一条小的Merkle路径就能认证一笔交易的存在，而不需要存储或者传输大量区块链中大多数内容。这种不需要维护一条完整的区块链的节点，又被称作简单支付验证（SPV）节点。 
